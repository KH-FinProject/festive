<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="com.project.festive.festiveserver.myPage.model.mapper.MyPageMapper">

	<!-- 회원의 비밀번호 조회 -->
	<select id="selectPw">
		SELECT PASSWORD
		FROM "MEMBER"
		WHERE MEMBER_NO =
		#{memberNo}
	</select>

	<!-- 회원 비밀번호 변경 -->
	<update id="changePw">
		UPDATE "MEMBER" SET
		PASSWORD = #{newEncodedPw}
		WHERE MEMBER_NO = #{memberNo}
	</update>


	<!-- 회원 탈퇴 -->
	<update id="withdrawal">
		UPDATE "MEMBER" SET
		MEMBER_DEL_FL = 'Y'
		WHERE MEMBER_NO
		= #{memberNo}
	</update>


	<!-- 내가 작성한 게시글 조회 -->
	<select id="selectMyPosts">

        SELECT
            b.BOARD_NO as boardNo,
            b.BOARD_TITLE as boardTitle,
            m.NICKNAME as memberNickname,
            b.BOARD_CREAT_DATE as boardCreateDate,
            b.READ_COUNT as boardViewCount,
            COUNT(l.MEMBER_NO) AS boardLikeCount
        FROM BOARD b
        JOIN MEMBER m ON b.MEMBER_NO = m.MEMBER_NO
        LEFT JOIN "LIKE" l ON b.BOARD_NO = l.BOARD_NO
        WHERE b.MEMBER_NO = #{memberNo}
        AND b.BOARD_DEL_FL = 'N'
        GROUP BY b.BOARD_NO, b.BOARD_TITLE, m.NICKNAME, b.BOARD_CREAT_DATE, b.READ_COUNT
        ORDER BY b.BOARD_CREAT_DATE DESC
    </select>
    
    <!-- 내가 작성한 댓글 조회 -->
    <select id="selectMyComments">
        SELECT c.COMMENT_NO,
               c.COMMENT_CONTENT,
               c.COMMENT_WRITE_DATE,
               c.BOARD_NO,
               m.MEMBER_NICKNAME,
               COUNT(cl.MEMBER_NO) AS LIKE_COUNT
        FROM "COMMENT" c
        JOIN MEMBER m ON c.MEMBER_NO = m.MEMBER_NO
        LEFT JOIN "COMMENT_LIKE" cl ON c.COMMENT_NO = cl.COMMENT_NO
        WHERE c.MEMBER_NO = #{memberNo} AND c.COMMENT_DEL_FL = 'N'
        GROUP BY c.COMMENT_NO, c.COMMENT_CONTENT, c.COMMENT_WRITE_DATE, c.BOARD_NO, m.MEMBER_NICKNAME
        ORDER BY c.COMMENT_WRITE_DATE DESC
    </select>
    
    <!-- 내 정보 수정 -->
    <update id="updateMemberInfo">
        UPDATE MEMBER
        SET TEL = #{tel},
            EMAIL = #{email},
            ADDRESS = #{address}
        WHERE MEMBER_NO = #{memberNo}
    </update>


	<select id="selectMyInfo">
		SELECT MEMBER_NO, MEMBER_PHONE, MEMBER_EMAIL, MEMBER_ADDRESS,
		MEMBER_DETAIL_ADDRESS, MEMBER_POST_CODE
		FROM MEMBER
		WHERE MEMBER_NO = #{memberNo}
	</select>

	<update id="updateMyInfo">
		UPDATE MEMBER
		SET
		MEMBER_PHONE = #{memberPhone},
		MEMBER_EMAIL = #{memberEmail},
		MEMBER_ADDRESS = #{memberAddress},
		MEMBER_DETAIL_ADDRESS = #{memberDetailAddress},
		MEMBER_POST_CODE = #{memberPostCode}
		WHERE MEMBER_NO = #{memberNo}
	</update>

</mapper>